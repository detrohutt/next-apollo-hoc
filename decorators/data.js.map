{"version":3,"sources":["../src/decorators/data.js"],"names":["ComposedComponent","opts","default","endpoint","add","WithData","Component","getInitialProps","ctx","serverState","apollo","data","cookie","composedInitialProps","cookieSource","process","browser","document","req","headers","apolloClient","getClient","router","asPath","pathname","query","error","rewind","cache","extract","constructor","props","render","displayName","propTypes","object","isRequired"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;kBAEe,6BAAa,CAACA,iBAAD,EAAoBC,IAApB,KAA6B;AACvD,MAAIA,KAAKC,OAAT,EAAkB;AAChBD,SAAKE,QAAL,GAAgBF,KAAKC,OAArB;AACA,WAAOD,KAAKC,OAAZ;AACD;AACD,mBAAOE,GAAP,CAAWH,IAAX;;AAEA,QAAMI,QAAN,SAAuB,gBAAMC,SAA7B,CAAuC;;AAQrC,iBAAaC,eAAb,CAA6BC,GAA7B,EAAkC;AAChC;AACA,UAAIC,cAAc;AAChBC,gBAAQ;AACNC,gBAAM;AADA,SADQ;AAIhBC,gBAAQ;;AAGV;AAPkB,OAAlB,CAQA,IAAIC,uBAAuB,EAA3B;AACA,UAAIb,kBAAkBO,eAAtB,EAAuC;AACrCM,+BAAuB,MAAMb,kBAAkBO,eAAlB,CAAkCC,GAAlC,CAA7B;AACD;;AAED;AACA;AACA,YAAMM,eAAeC,QAAQC,OAAR,GAAkBC,QAAlB,GAA6BT,IAAIU,GAAJ,CAAQC,OAA1D;AACA,uBAAOf,GAAP,CAAW,EAAEU,YAAF,EAAX;AACA,YAAMM,eAAe,iBAAOC,SAAP,EAArB;AACA,UAAI;AACF;AACA,cAAM,kCACJ;AAAA;AAAA,YAAgB,QAAQD,YAAxB;AACE,wCAAC,iBAAD,EAAuBP,oBAAvB;AADF,SADI,EAIJ;AACES,kBAAQ;AACNC,oBAAQf,IAAIe,MADN;AAENC,sBAAUhB,IAAIgB,QAFR;AAGNC,mBAAOjB,IAAIiB;AAHL;AADV,SAJI,CAAN;AAYD,OAdD,CAcE,OAAOC,KAAP,EAAc;AACd;AACA;AACA;AACD;;AAED,UAAI,CAACX,QAAQC,OAAb,EAAsB;AACpB;AACA;AACA,uBAAKW,MAAL;AACD;;AAED;AACAlB,oBAAc;AACZC,gBAAQ;AACNC,gBAAMS,aAAaQ,KAAb,CAAmBC,OAAnB;AADA,SADI;AAIZjB,gBAAQE,aAAaF;AAJT,OAAd;;AAOA;AACEH;AADF,SAEKI,oBAFL;AAID;;AAEDiB,gBAAYC,KAAZ,EAAmB;AACjB,YAAMA,KAAN;AACA,YAAMjB,eAAeC,QAAQC,OAAR,GAAkBC,QAAlB,GAA6B,KAAKc,KAAL,CAAWtB,WAA7D;AACA,uBAAOL,GAAP,CAAW,EAAEU,YAAF,EAAX;AACA,WAAKM,YAAL,GAAoB,iBAAOC,SAAP,CAAiB,KAAKU,KAAL,CAAWtB,WAAX,CAAuBC,MAAvB,CAA8BC,IAA/C,CAApB;AACD;;AAEDqB,aAAS;AACP,aACE;AAAA;AAAA,UAAgB,QAAQ,KAAKZ,YAA7B;AACE,sCAAC,iBAAD,EAAuB,KAAKW,KAA5B;AADF,OADF;AAKD;AAjFoC;;AAAjC1B,UAPiD,CAQ9C4B,WAR8C,GAQ/B,YAAW,wCAC/BjC,iBAD+B,CAE/B,GAVmD;AAOjDK,UAPiD,CAW9C6B,SAX8C,GAWlC;AACjBzB,iBAAa,oBAAU0B,MAAV,CAAiBC;AADb,GAXkC;AA2FvD,SAAO/B,QAAP;AACD,CA5Fc,C","file":"data.js","sourcesContent":["import React from 'react'\nimport PropTypes from 'prop-types'\nimport { ApolloProvider, getDataFromTree } from 'react-apollo'\nimport Head from 'next/head'\n\nimport config from '../config'\nimport apollo from '../apollo'\nimport { getDecorator, getComponentDisplayName } from '../lib/component'\n\nexport default getDecorator((ComposedComponent, opts) => {\n  if (opts.default) {\n    opts.endpoint = opts.default\n    delete opts.default\n  }\n  config.add(opts)\n\n  class WithData extends React.Component {\n    static displayName = `WithData(${getComponentDisplayName(\n      ComposedComponent\n    )})`\n    static propTypes = {\n      serverState: PropTypes.object.isRequired\n    }\n\n    static async getInitialProps(ctx) {\n      // Initial serverState with apollo (empty)\n      let serverState = {\n        apollo: {\n          data: {},\n        },\n        cookie: null\n      }\n\n      // Evaluate the composed component's getInitialProps()\n      let composedInitialProps = {}\n      if (ComposedComponent.getInitialProps) {\n        composedInitialProps = await ComposedComponent.getInitialProps(ctx)\n      }\n\n      // Run all GraphQL queries in the component tree\n      // and extract the resulting data\n      const cookieSource = process.browser ? document : ctx.req.headers\n      config.add({ cookieSource })\n      const apolloClient = apollo.getClient()\n      try {\n        // Run all GraphQL queries\n        await getDataFromTree(\n          <ApolloProvider client={apolloClient}>\n            <ComposedComponent {...composedInitialProps} />\n          </ApolloProvider>,\n          {\n            router: {\n              asPath: ctx.asPath,\n              pathname: ctx.pathname,\n              query: ctx.query\n            }\n          }\n        )\n      } catch (error) {\n        // Prevent Apollo Client GraphQL errors from crashing SSR.\n        // Handle them in components via the data.error prop:\n        // http://dev.apollodata.com/react/api-queries.html#graphql-query-data-error\n      }\n\n      if (!process.browser) {\n        // getDataFromTree does not call componentWillUnmount\n        // head side effect therefore need to be cleared manually\n        Head.rewind()\n      }\n\n      // Extract query data from the Apollo store\n      serverState = {\n        apollo: {\n          data: apolloClient.cache.extract(),\n        },\n        cookie: cookieSource.cookie\n      }\n\n      return {\n        serverState,\n        ...composedInitialProps\n      }\n    }\n\n    constructor(props) {\n      super(props)\n      const cookieSource = process.browser ? document : this.props.serverState\n      config.add({ cookieSource })\n      this.apolloClient = apollo.getClient(this.props.serverState.apollo.data)\n    }\n\n    render() {\n      return (\n        <ApolloProvider client={this.apolloClient}>\n          <ComposedComponent {...this.props} />\n        </ApolloProvider>\n      )\n    }\n  }\n\n  return WithData\n})\n"]}